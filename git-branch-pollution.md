# 背景

同个仓库内多个项目协同开发，因为开发的周期重叠，导致各自拉取的分支开发完成后，为了在测试环境测试， 都同步到dev分支（用于发布测试的分支），导致有的项目从dev分支拉取后，并在其他人未上线的项目的基础上进行开发，之后出现先开发的项目延迟上线，而已经被污染的项目需要先上线，就需要手动去回滚版本了。

# 反思

Q：fork分支是否应该在dev上？

A：当然是否，照理来说，fork任何分支都应该在stable的版本上进行fork，可以避免一些beta版本中的bug被一起fork出来。所以拉取分支的话，应该是从上一次正式上线的master分支进行拉取。

Q：拉取的分支是以什么为单位？怎么测试与正式发布？

A：以项目为单位。之前拉取分支是以人为单位，每个人拥有自己独立的开发分支，然而这种情况下就会出现，一个人如果同时负责一个仓库内的多个项目开发（比如一个项目还在提测（或者延迟上线），又投入到另一个项目的开发），那么可能出现在个人分支内出现污染。所以目前的解决方案是以项目为单位，每个项目拥有自己独立的分支，需要发布到测试环境的情况下，可以merge到dev，如果有冲突，就在dev上解决冲突，但不能反向merge dev到项目分支。在上线前夕，可以提PR到master分支，如果审批过程中有出现冲突，那么可以在项目分支merge master分支来解决冲突后发布（解决过程中需要与冲突部分的负责人确认冲突解决情况是否影响到之前上线的功能）

Q：同个仓库内的项目分支是否有规范？

A：目前建议是：feature/{项目名}\_{年月日}\_{时间戳}

Q：master分支合并开发分支是否使用类似 git merge --squash 命令来保证master分支提交历史的干净？

A:  基于项目规范的完善，后续开发分支合并到 master 分支并正常线上后，会删除该分支，防止分支爆炸式增长。可让master分支保留提交历史。

Q：若 master 分支保留提交历史，出现以下情况：上线前夕，master 分支不慎合并错误的开发分支，如何快速定位 master 分支上一次线上发布时的最后 commit 并做 reset 操作。

A:  虽然可通过 Plus 过滤条件定位 commit 并做 reset 操作，更推荐的做法：对 master 分支打 tag 标签。对于线上测试正常的 master 分支，通过打 tag 标签为 reset 操作提供凭证。可参考命令：\`git tag -n --sort=-taggerdate\` 获取 tag 列表，\`git log --format="%h" 你的 tag \| head -n 1\` 获取 commit。对于 tag 规范，可采用版本号或其他语义化的方式。

# 总结

从之前的坑中得到的教训是拉取分支要从master上拉取，开发过程中避免开发分支被污染。但只要多人在同一个仓库下开发，冲突是无法避免的，解决冲突不应该默默解决，更要积极联系冲突部分的开发负责人，然后沟通解决，让各方都知道冲突和解决的方法。避免在上线前夕，也出现冲突后，缺少测试环境稳定解决的方案的参考。

# 推荐工具

[regular-branch-creator](https://github.com/LeonDWong/regular-branch-creator)


